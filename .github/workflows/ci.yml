name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, webresigning ]
  pull_request:
    branches: [ main, develop ]
  release:
    types: [ created ]

env:
  PYTHON_VERSION: '3.11'
  
jobs:
  # ============================================================================
  # Job 1: Code Quality & Linting
  # ============================================================================
  lint:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black flake8 mypy pylint isort
          pip install -r requirements.txt
      
      - name: Run Black (Code Formatting)
        run: |
          black --check --diff web/ src/ tests/
        continue-on-error: true
      
      - name: Run isort (Import Sorting)
        run: |
          isort --check-only --diff web/ src/ tests/
        continue-on-error: true
      
      - name: Run Flake8 (Style Guide)
        run: |
          flake8 web/ src/ tests/ --max-line-length=120 --extend-ignore=E203,W503
        continue-on-error: true
      
      - name: Run Pylint (Static Analysis)
        run: |
          pylint web/ src/ --disable=C0111,R0903,R0913 --max-line-length=120
        continue-on-error: true
      
      - name: Run MyPy (Type Checking)
        run: |
          mypy web/ src/ --ignore-missing-imports --no-strict-optional
        continue-on-error: true

  # ============================================================================
  # Job 2: Security Scanning
  # ============================================================================
  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit
          pip install -r requirements.txt
      
      - name: Run Safety (Dependency Vulnerabilities)
        run: |
          safety check --json
        continue-on-error: true
      
      - name: Run Bandit (Security Issues)
        run: |
          bandit -r web/ src/ -f json -o bandit-report.json
        continue-on-error: true
      
      - name: Upload Bandit Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-report
          path: bandit-report.json

  # ============================================================================
  # Job 3: Unit Tests
  # ============================================================================
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install GPG
        run: |
          sudo apt-get update
          sudo apt-get install -y gnupg
          gpg --version
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Create directories
        run: |
          mkdir -p uploads signed temp_keys logs
      
      - name: Run Unit Tests
        run: |
          pytest tests/test_key_manager.py tests/test_verify.py tests/test_resigner.py \
            -v \
            --cov=web \
            --cov=src \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --junitxml=junit-unit.xml \
            -m "not integration"
      
      - name: Upload Unit Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results
          path: |
            junit-unit.xml
            htmlcov/
      
      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-unit
          fail_ci_if_error: false

  # ============================================================================
  # Job 4: Integration Tests
  # ============================================================================
  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install GPG
        run: |
          sudo apt-get update
          sudo apt-get install -y gnupg
          gpg --version
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Create directories
        run: |
          mkdir -p uploads signed temp_keys logs
      
      - name: Run Integration Tests
        run: |
          pytest tests/test_web_api.py tests/test_gpg.py tests/test_workflow.py \
            -v \
            --cov=web \
            --cov=src \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --junitxml=junit-integration.xml \
            -m "integration or not integration"
      
      - name: Upload Integration Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: |
            junit-integration.xml
            htmlcov/
      
      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: integrationtests
          name: codecov-integration
          fail_ci_if_error: false

  # ============================================================================
  # Job 5: Build Docker Image
  # ============================================================================
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [lint, test-unit, test-integration]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/appimage-resigner
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Image digest
        run: echo ${{ steps.meta.outputs.digest }}

  # ============================================================================
  # Job 6: Generate Documentation
  # ============================================================================
  docs:
    name: Generate Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pdoc3 sphinx sphinx-rtd-theme
          pip install -r requirements.txt
      
      - name: Generate API Documentation
        run: |
          pdoc3 --html --output-dir docs/api web src --force
      
      - name: Upload Documentation
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: docs/api/

  # ============================================================================
  # Job 7: Performance Tests (Optional)
  # ============================================================================
  test-performance:
    name: Performance Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install locust pytest-benchmark
      
      - name: Run Performance Tests
        run: |
          pytest tests/ -v -m "slow" --benchmark-only
        continue-on-error: true

  # ============================================================================
  # Job 8: Deploy to Staging (Optional)
  # ============================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-docker]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://staging.appimage-resigner.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to Staging Server
        run: |
          echo "Deploying to staging..."
          # Add your deployment script here
          # e.g., SSH to server, pull latest image, restart containers
      
      - name: Health Check
        run: |
          sleep 10
          curl -f https://staging.appimage-resigner.com/health || exit 1

  # ============================================================================
  # Job 9: Deploy to Production (Optional)
  # ============================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-docker]
    if: github.event_name == 'release'
    environment:
      name: production
      url: https://appimage-resigner.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to Production Server
        run: |
          echo "Deploying to production..."
          # Add your deployment script here
      
      - name: Health Check
        run: |
          sleep 10
          curl -f https://appimage-resigner.com/health || exit 1
      
      - name: Notify Deployment
        run: |
          echo "Production deployment successful!"
          # Add notification (Slack, email, etc.)

  # ============================================================================
  # Job 10: Create Release Notes (On Release)
  # ============================================================================
  release-notes:
    name: Generate Release Notes
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Generate Changelog
        uses: orhun/git-cliff-action@v3
        with:
          config: cliff.toml
          args: --latest --strip header
        env:
          OUTPUT: CHANGELOG.md
      
      - name: Upload Changelog
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: CHANGELOG.md

# ==============================================================================
# Workflow Summary
# ==============================================================================
# This CI/CD pipeline includes:
# - Code quality checks (Black, isort, Flake8, Pylint, MyPy)
# - Security scanning (Safety, Bandit)
# - Unit tests with coverage
# - Integration tests with coverage
# - Docker image building and pushing
# - Documentation generation
# - Optional performance tests
# - Optional deployment to staging/production
# - Release notes generation
# ==============================================================================
